name: Deploy Backend to DigitalOcean

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'
      - 'tsconfig.json'
      - 'nest-cli.json'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  NODE_VERSION: '20.x'

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies (for validation)
        run: |
          npm ci
          echo "âœ… Dependencies installed successfully"

      - name: Build application (validation)
        run: |
          npm run build
          echo "âœ… Build successful"

      - name: Deploy to DigitalOcean
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          timeout: 300s
          script: |
            set -e
            
            echo "ğŸš€ Starting deployment to DigitalOcean..."
            echo "ğŸ“… Deployment time: $(date)"
            echo "ğŸ”„ Branch: main"
            echo "ğŸ“ Server: $(hostname)"
            
            APP_DIR="/var/www/sports-platform-api"
            cd $APP_DIR
            
            # Check if directory exists
            if [ ! -d "$APP_DIR" ]; then
              echo "âŒ Error: Application directory not found!"
              exit 1
            fi
            
            # Pull latest changes
            echo "ğŸ“¥ Pulling latest changes from GitHub..."
            git fetch origin main
            git checkout main
            git pull origin main
            
            # Show commit info
            echo "ğŸ“ Latest commit:"
            git log -1 --oneline
            
            # Install all dependencies (including dev for build)
            echo "ğŸ“¦ Installing dependencies..."
            npm ci
            
            # Build application
            echo "ğŸ”¨ Building application..."
            npm run build
            
            # Verify build
            if [ ! -f "dist/main.js" ]; then
              echo "âŒ Error: Build failed - dist/main.js not found!"
              exit 1
            fi
            
            echo "âœ… Build successful"
            
            # Restart PM2
            echo "ğŸ”„ Restarting application with PM2..."
            pm2 restart sports-platform-api --update-env
            
            # Wait for app to start
            sleep 3
            
            # Check PM2 status
            echo "ğŸ“Š PM2 Status:"
            pm2 status
            
            # Health check
            echo "ğŸ¥ Running health check..."
            HEALTH_CHECK=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/api/v1/health || echo "000")
            
            if [ "$HEALTH_CHECK" = "200" ]; then
              echo "âœ… Health check passed (HTTP $HEALTH_CHECK)"
              echo "âœ… Deployment successful!"
            else
              echo "âš ï¸  Health check returned HTTP $HEALTH_CHECK"
              echo "ğŸ“‹ Recent PM2 logs:"
              pm2 logs sports-platform-api --lines 20 --nostream || true
              exit 1
            fi
            
            echo ""
            echo "ğŸ‰ Deployment completed successfully!"
            echo "ğŸŒ API: https://api.scorenews.net/api/v1"
            echo "ğŸ“Š Health: https://api.scorenews.net/api/v1/health"

      - name: Deployment Summary
        if: success()
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Production URL: https://api.scorenews.net/api/v1"
          echo "ğŸ“Š Health Check: https://api.scorenews.net/api/v1/health"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Please check the logs above for details."

