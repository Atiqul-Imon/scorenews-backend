name: Deploy Backend to DigitalOcean

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'
      - 'tsconfig.json'
      - 'nest-cli.json'
      - 'Dockerfile'
      - 'docker-compose.yml'
      - '.dockerignore'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  NODE_VERSION: '20.x'

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies (for validation)
        run: |
          npm ci
          echo "âœ… Dependencies installed successfully"

      - name: Build application (validation)
        run: |
          npm run build
          echo "âœ… Build successful"

      - name: Deploy to DigitalOcean with Docker
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          timeout: 600s
          script: |
            set -e
            
            echo "ğŸ³ Starting Docker deployment to DigitalOcean..."
            echo "ğŸ“… Deployment time: $(date)"
            echo "ğŸ”„ Branch: main"
            echo "ğŸ“ Server: $(hostname)"
            
            APP_DIR="/var/www/sports-platform-api"
            cd $APP_DIR
            
            # Check if directory exists
            if [ ! -d "$APP_DIR" ]; then
              echo "âŒ Error: Application directory not found!"
              exit 1
            fi
            
            # Check Docker
            echo "ğŸ³ Checking Docker..."
            if ! command -v docker &> /dev/null; then
              echo "âŒ Docker is not installed!"
              exit 1
            fi
            docker --version
            docker-compose --version
            
            # Pull latest changes
            echo "ğŸ“¥ Pulling latest changes from GitHub..."
            git fetch origin main
            
            # Handle any local changes (stash or discard)
            if ! git diff-index --quiet HEAD --; then
              echo "âš ï¸  Local changes detected, stashing them..."
              git stash save "CI/CD: Stashing local changes before deployment $(date +%Y%m%d-%H%M%S)" || true
            fi
            
            git checkout main
            git reset --hard origin/main
            
            # Show commit info
            echo "ğŸ“ Latest commit:"
            git log -1 --oneline
            
            # Stop existing container if running
            echo "ğŸ›‘ Stopping existing container..."
            docker-compose down || true
            
            # Build and start new container
            echo "ğŸ”¨ Building Docker image..."
            docker-compose build --no-cache
            
            echo "ğŸš€ Starting container..."
            docker-compose up -d
            
            # Wait for container to start
            echo "â³ Waiting for container to be ready..."
            sleep 10
            
            # Check container status
            echo "ğŸ“Š Container Status:"
            docker-compose ps
            
            # Wait for health check
            echo "ğŸ¥ Waiting for health check..."
            MAX_ATTEMPTS=30
            ATTEMPT=0
            HEALTHY=false
            
            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              HEALTH_CHECK=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5000/api/v1/health || echo "000")
              if [ "$HEALTH_CHECK" = "200" ]; then
                HEALTHY=true
                break
              fi
              ATTEMPT=$((ATTEMPT + 1))
              echo "  Attempt $ATTEMPT/$MAX_ATTEMPTS: HTTP $HEALTH_CHECK (waiting...)"
              sleep 2
            done
            
            if [ "$HEALTHY" = true ]; then
              echo "âœ… Health check passed (HTTP 200)"
              echo "âœ… Deployment successful!"
              
              # Show container logs
              echo "ğŸ“‹ Container logs (last 20 lines):"
              docker-compose logs --tail=20
            else
              echo "âŒ Health check failed after $MAX_ATTEMPTS attempts"
              echo "ğŸ“‹ Container logs:"
              docker-compose logs --tail=50
              echo "ğŸ“‹ Container status:"
              docker-compose ps
              exit 1
            fi
            
            echo ""
            echo "ğŸ‰ Docker deployment completed successfully!"
            echo "ğŸŒ API: https://api.scorenews.net/api/v1"
            echo "ğŸ“Š Health: https://api.scorenews.net/api/v1/health"

      - name: Deployment Summary
        if: success()
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Production URL: https://api.scorenews.net/api/v1"
          echo "ğŸ“Š Health Check: https://api.scorenews.net/api/v1/health"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "Please check the logs above for details."

